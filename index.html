<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>Eugen Dimant</title>
  <meta name="description" content="Research in social norms, honesty, polarization, corruption, and migration." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2f;
      --panel2:#101e38;
      --text:#e7eefc;
      --muted:#a9b7d6;
      --muted2:#7f92bd;
      --line:rgba(231,238,252,.12);
      --chip:rgba(231,238,252,.08);
      --chip2:rgba(231,238,252,.12);
      --accent:#67b3ff;
      --accent2:#9bd1ff;
      --good:#58d39b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:22px;
      --max: 1480px; /* wider so the two right columns can be wider without squeezing the hero */
      --gap: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 18% 0%, rgba(103,179,255,.18), rgba(0,0,0,0)),
        radial-gradient(900px 500px at 88% 18%, rgba(155,209,255,.10), rgba(0,0,0,0)),
        linear-gradient(180deg, #0b1220, #070b14 70%);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:var(--max); margin:0 auto; padding:22px 18px 60px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 6px 18px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      text-decoration:none;
      font-weight:700;
      letter-spacing:.2px;
    }
    .brand .dot{
      width:10px; height:10px; border-radius:999px; background:var(--accent);
      box-shadow:0 0 0 4px rgba(103,179,255,.18);
    }
    nav{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .navlink{
      text-decoration:none;
      font-weight:600;
      font-size:13px;
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      border:1px solid transparent;
    }
    .navlink:hover{color:var(--text); border-color:var(--line); background:rgba(231,238,252,.04);}
    .grid{
      display:grid;
      grid-template-columns: minmax(520px, 1.35fr) 420px 420px; /* wider right columns */
      gap:var(--gap);
      align-items:start;
    }
    @media (max-width: 1240px){
      .grid{grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .inner{padding:18px;}
    .card h2{margin:0 0 10px; font-size:18px; letter-spacing:.1px;}
    .sub{color:var(--muted); font-size:13px; line-height:1.45;}
    .pillrow{display:flex; flex-wrap:wrap; gap:8px; margin-top:12px;}
    .pill{
      display:inline-flex; align-items:center; gap:7px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(231,238,252,.03);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pill b{color:var(--text); font-weight:700}
    .cta-row{display:flex; flex-wrap:wrap; gap:10px; margin-top:14px;}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(231,238,252,.03);
      color:var(--text);
      text-decoration:none;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{background:rgba(231,238,252,.06); border-color:rgba(231,238,252,.22);}
    .btn.primary{
      background: linear-gradient(180deg, rgba(103,179,255,.22), rgba(103,179,255,.10));
      border-color:rgba(103,179,255,.35);
    }
    .btn.primary:hover{border-color:rgba(103,179,255,.55);}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .hero{
      display:grid;
      grid-template-columns: 130px 1fr;
      gap:16px;
      align-items:center;
    }
    @media (max-width: 520px){
      .hero{grid-template-columns: 1fr;}
    }
    .avatar{
      width:130px; height:130px;
      border-radius:28px;
      overflow:hidden;
      border:1px solid var(--line);
      background:rgba(231,238,252,.05);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      position:relative;
      flex:0 0 auto;
    }
    
    .avatar-fallback{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      letter-spacing:.6px;
      color:rgba(231,238,252,.55);
      font-size:22px;
      background: radial-gradient(240px 140px at 30% 20%, rgba(103,179,255,.25), rgba(0,0,0,0));
    }

    .avatar img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .h-title{
      margin:0;
      font-size:34px;
      line-height:1.06;
      letter-spacing:-.4px;
    }
    .h-roles{
      margin-top:8px;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
    }
    .quicklinks{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}

    /* Right column lists */
    .list{margin:0; padding-left:18px;}
    .list li{margin:10px 0; color:var(--muted); line-height:1.35;}
    .list li b{color:var(--text)}
    .mini-link{color:var(--accent2); text-decoration:none; font-weight:700;}
    .mini-link:hover{text-decoration:underline;}

    /* Sections */
    .section{margin-top:18px;}
    .section-title{
      display:flex; align-items:baseline; justify-content:space-between;
      gap:12px; margin:22px 0 10px; padding:0 4px;
    }
    .section-title h2{
      margin:0;
      font-size:18px;
      color:var(--text);
    }
    .section-title .hint{color:var(--muted2); font-size:12px;}

    /* Research */
    .research-shell{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:var(--gap);
      align-items:start;
    }
    @media (max-width: 1100px){
      .research-shell{grid-template-columns: 1fr;}
    }

    .filters{
      position:sticky;
      top:16px;
    }
    @media (max-width: 1100px){
      .filters{position:relative; top:auto;}
    }

    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin:10px 0 12px;
    }
    .tab{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(231,238,252,.03);
      color:var(--muted);
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:rgba(103,179,255,.16);
      border-color:rgba(103,179,255,.35);
      color:var(--text);
    }
    .field{margin-top:12px;}
    .label{font-size:12px; color:var(--muted2); font-weight:700; margin-bottom:7px;}
    .input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.10);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.10);
      color:var(--text);
      font-size:13px;
      outline:none;
    }
    .chipgrid{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top:6px;
    }
    .chip{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--chip);
      color:var(--muted);
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{background:var(--chip2); color:var(--text);}
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(231,238,252,.03);
      color:var(--muted);
      font-weight:700;
      font-size:12px;
      margin-top:12px;
    }
    .toggle input{transform:scale(1.05)}
    .results-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      padding:6px 6px 10px;
    }
    .results-head .count{color:var(--muted); font-weight:700; font-size:13px;}
    .results{padding:0 6px 12px;}
    .year-group{
      margin-top:12px;
    }
    .year-label{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin:14px 4px 10px;
    }
    .year-label h3{
      margin:0;
      font-size:14px;
      color:var(--muted2);
      letter-spacing:.4px;
      text-transform:uppercase;
    }
    .backlink{
      font-size:12px;
      color:var(--accent2);
      font-weight:700;
      text-decoration:none;
    }
    .backlink:hover{text-decoration:underline;}

    .pub{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(231,238,252,.02);
      padding:14px 14px 12px;
      margin:10px 0;
    }
    .pub-title{
      margin:0;
      font-size:15px;
      line-height:1.25;
      color:var(--text);
    }
    .pub-meta{
      margin-top:6px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
    }
    .pub-badges{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top:10px;
    }
    .badge{
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      border:1px solid var(--line);
      background:rgba(231,238,252,.03);
      padding:6px 9px;
      border-radius:999px;
    }
    .badge.year{color:var(--text); border-color:rgba(103,179,255,.35); background:rgba(103,179,255,.10);}
    .badge.type{color:var(--good); border-color:rgba(88,211,155,.35); background:rgba(88,211,155,.10);}
    .pub-actions{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top:12px;
    }
    .pub-actions a, .pub-actions button{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(231,238,252,.03);
      color:var(--text);
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      text-decoration:none;
    }
    .pub-actions a:hover, .pub-actions button:hover{background:rgba(231,238,252,.06); border-color:rgba(231,238,252,.22);}
    .pub-actions button{font-family:inherit}
    .notice{
      padding:12px 12px;
      border-radius:14px;
      border:1px dashed rgba(231,238,252,.20);
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
      background:rgba(231,238,252,.02);
      margin:10px 6px 0;
    }
    .inline{
      display:inline-flex; gap:8px; flex-wrap:wrap; align-items:center;
    }

    /* Vita */
    .pdf-frame{
      width:100%;
      height:880px;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:rgba(0,0,0,.16);
    }

    /* Twitter */
    .tweetbox{
      border-top:1px solid var(--line);
      margin-top:14px;
      padding-top:14px;
    }

    /* footer */
    footer{
      margin-top:26px;
      color:var(--muted2);
      font-size:12px;
      padding:0 6px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <a class="brand" href="#home" aria-label="Go to top">
        <span class="dot" aria-hidden="true"></span>
        Eugen Dimant
      </a>
      <nav aria-label="Primary">
        <a class="navlink" href="#home">Home</a>
        <a class="navlink" href="#research">Research</a>
        <a class="navlink" href="#vita">Vita</a>
        <a class="navlink" href="#contact">Contact</a>
        <a class="navlink" href="https://sites.google.com/view/eugendimant" target="_blank" rel="noopener">Legacy site</a>
      </nav>
    </div>

    <!-- HERO GRID -->
    <div id="home" class="grid">
      <!-- Left hero -->
      <div class="card">
        <div class="inner">
          <div class="hero">
            <div class="avatar" aria-label="Profile photo">
              <img src="assets/eugen_dimant.jpg" alt="Eugen Dimant"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div class="avatar-fallback" aria-hidden="true" style="display:none;">ED</div>
            </div>
            <div>
              <h1 class="h-title">Eugen Dimant</h1>
              <div class="h-roles">
                Associate Professor of Practice, Behavioral and Decision Sciences (University of Pennsylvania)
              </div>

              <div class="cta-row">
                <a class="btn primary" href="#research">Explore publications</a>
                <a class="btn" href="#vita">CV</a>
                <a class="btn ghost" href="mailto:edimant@sas.upenn.edu">Email</a>
              </div>

              <div class="quicklinks" aria-label="Profiles">
                <a class="btn" href="https://scholar.google.com/citations?user=3Ylbe0YAAAAJ" target="_blank" rel="noopener">Google Scholar</a>
                <a class="btn" href="https://www.linkedin.com/in/REPLACE_ME/" target="_blank" rel="noopener">LinkedIn</a>
                <a class="btn" href="https://x.com/REPLACE_ME/" target="_blank" rel="noopener">X (Twitter)</a>
              </div>
            </div>
          </div>

          <div class="section">
            <div class="sub" style="margin-top:10px;">
              I study how social norms and incentives shape honesty, cooperation, and polarization, and how these mechanisms matter for policy and organizations.
            </div>

            <div class="pillrow" aria-label="Focus areas">
              <span class="pill"><b>Focus</b> norms, honesty, polarization, corruption, migration</span>
              <span class="pill"><b>Methods</b> lab and field experiments, causal inference, observational data</span>
              <span class="pill"><b>Goal</b> research that travels to policy and practice</span>
              <span class="pill"><b>Affiliation</b> Stanford University</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Research news -->
      <div class="card">
        <div class="inner">
          <h2>Research news</h2>
          <ul class="list">
            <li><b>Apr 2025:</b> new publications on social norms and norm heterogeneity in 6 top journals.</li>
            <li><b>Nov 2024:</b> new publications in Management Science, The Economic Journal, PNAS Nexus, and European Economic Review.</li>
            <li><b>Jun 2023:</b> new publications in PNAS Nexus and Games and Economic Behavior.</li>
            <li><b>Sep 2022:</b> new publication in Nature and multiple others on COVID-19 and compliance.</li>
          </ul>
          <div class="sub" style="margin-top:12px;">
            <a class="mini-link" href="#research">See the full list and filter by year and topic</a>
          </div>
        </div>
      </div>

      <!-- Selected publications + tweets -->
      <div class="card">
        <div class="inner">
          <h2>Selected publications</h2>
          <ul class="list">
            <li><b>Nudging Teachers</b> (PNAS, 2025)</li>
            <li><b>Strategic Behavior with Tight, Loose, and Polarized Norms</b> (Management Science, 2024)</li>
            <li><b>Paying Them to Hate US</b> (The Economic Journal, 2024)</li>
            <li><b>Social Proximity and the Erosion of Norm Compliance</b> (Games and Economic Behavior, 2022)</li>
            <li><b>Competition and Moral Behavior</b> (PNAS, 2023)</li>
            <li><b>Nudging Enforcers</b> (PNAS Nexus, 2023)</li>
          </ul>

          <div class="tweetbox">
            <h2 style="margin-bottom:10px;">Latest on X</h2>
            <div class="sub" style="margin-bottom:10px;">
              If this does not render (some browsers block third-party widgets), open the profile directly:
              <a class="mini-link" href="https://x.com/REPLACE_ME/" target="_blank" rel="noopener">x.com/REPLACE_ME</a>
            </div>
            <a class="twitter-timeline" data-height="520" data-dnt="true" href="https://twitter.com/REPLACE_ME?ref_src=twsrc%5Etfw">Tweets by @eugen_dimant</a>
          </div>
        </div>
      </div>
    </div>

    <!-- RESEARCH -->
    <div id="research" class="section-title">
      <h2>Research</h2>
      <div class="hint">Filters work on a locally rendered list. Source: your legacy Google Sites research page.</div>
    </div>

    <div class="card">
      <div class="inner">
        <div class="research-shell">
          <!-- Filters -->
          <div class="filters">
            <div class="tabs" role="tablist" aria-label="Publication type tabs">
              <div class="tab active" role="tab" tabindex="0" data-type="all">All publications</div>
              <div class="tab" role="tab" tabindex="0" data-type="peer-reviewed">Peer-reviewed</div>
              <div class="tab" role="tab" tabindex="0" data-type="preprint">Pre-Prints</div>
            </div>

            <div class="field">
              <div class="label">Search title, venue, authors</div>
              <input id="q" class="input" placeholder="Try: norms, polarization, honesty, migration" />
            </div>

            <div class="field">
              <div class="label">Year</div>
              <div id="years" class="chipgrid"></div>
            </div>

            <div class="field">
              <div class="label">Topics (from titles)</div>
              <div id="topics" class="chipgrid"></div>
            </div>

            <div class="toggle">
              <input id="pdfOnly" type="checkbox" />
              <label for="pdfOnly">Show only items with a PDF or ungated link</label>
            </div>

            <div class="field">
              <div class="row">
                <div style="flex:1; min-width:170px;">
                  <div class="label">Sort</div>
                  <select id="sort" class="select">
                    <option value="newest" selected>newest</option>
                    <option value="oldest">oldest</option>
                    <option value="title">title</option>
                  </select>
                </div>
                <div style="flex:1; min-width:170px;">
                  <div class="label">Jump to year</div>
                  <select id="jump" class="select"></select>
                </div>
              </div>
            </div>

            <div class="notice" id="sourceNote">
              Loading publications from the legacy research page. If your browser blocks cross-site requests, the page will fall back to an embedded legacy view.
            </div>
          </div>

          <!-- Results -->
          <div>
            <div class="results-head">
              <div class="count" id="count">0 results</div>
              <div class="inline">
                <a class="btn" href="https://sites.google.com/view/eugendimant/research" target="_blank" rel="noopener">Open legacy research page</a>
                <a class="btn" href="https://scholar.google.com/citations?user=3Ylbe0YAAAAJ" target="_blank" rel="noopener">Open Scholar profile</a>
              </div>
            </div>
            <div id="results" class="results"></div>

            <div id="legacyFallback" style="display:none; margin:12px 6px 0;">
              <div class="notice">
                Your browser blocked reading the legacy research page. The embedded view below keeps all links working.
              </div>
              <div class="pdf-frame" style="height:900px; margin-top:12px;">
                <iframe title="Legacy research page" src="https://sites.google.com/view/eugendimant/research" style="width:100%; height:100%; border:0;"></iframe>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- VITA -->
    <div id="vita" class="section-title">
      <h2>Vita</h2>
      <div class="hint">Embedded PDF (put CV_Eugen_Dimant.pdf in the repository root).</div>
    </div>

    <div class="card">
      <div class="inner">
        <div class="cta-row" style="margin-top:0;">
          <a class="btn primary" href="CV_Eugen_Dimant.pdf" target="_blank" rel="noopener">Open CV PDF</a>
</div>
        <div class="pdf-frame" style="margin-top:14px;">
          <iframe title="CV PDF" src="CV_Eugen_Dimant.pdf#view=FitH" style="width:100%; height:100%; border:0;"></iframe>
        </div>
        <div class="sub" style="margin-top:10px;">
          If the embed does not load, use the “Open CV PDF” button above.
        </div>
      </div>
    </div>

    <!-- CONTACT -->
    <div id="contact" class="section-title">
      <h2>Contact</h2>
      <div class="hint">Quick ways to reach me.</div>
    </div>

    <div class="card">
      <div class="inner">
        <div class="sub">
          <b>University of Pennsylvania</b><br>
          Behavioral and Decision Sciences Program<br>
          Email: <a class="mini-link" href="mailto:edimant@sas.upenn.edu">edimant@sas.upenn.edu</a><br>
          </div>

        <div class="pillrow" style="margin-top:14px;">
          <a class="btn" href="https://scholar.google.com/citations?user=3Ylbe0YAAAAJ" target="_blank" rel="noopener">Google Scholar</a>
          <a class="btn" href="https://www.linkedin.com/in/REPLACE_ME/" target="_blank" rel="noopener">LinkedIn</a>
          <a class="btn" href="https://x.com/REPLACE_ME/" target="_blank" rel="noopener">X (Twitter)</a>
        </div>
      </div>
    </div>

    <footer>
      © <span id="year"></span> Eugen Dimant. Built as a single static page (GitHub Pages friendly).
    </footer>
  </div>

  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

  <script>
    // ---------------------------
    // Configuration
    // ---------------------------
    const LEGACY_RESEARCH_URL = "https://sites.google.com/view/eugendimant/research";

    // Topic tags derived from titles. Adjust freely.
    const TOPIC_RULES = [
      { tag: "social norms", re: /(norm|norms|pluralism|tight|loose)/i },
      { tag: "polarization", re: /(polarization|partisan|politic)/i },
      { tag: "honesty", re: /(honest|honesty|lie|lying|deceit)/i },
      { tag: "covid-19", re: /(covid|pandemic|mask|distanc|stay-at-home)/i },
      { tag: "corruption", re: /(corrupt)/i },
      { tag: "migration", re: /(migration|refugee|exodus|asylum)/i },
      { tag: "terrorism", re: /(terror)/i },
      { tag: "punishment", re: /(punish|sanction|enforc)/i },
      { tag: "competition", re: /(competition)/i },
      { tag: "tax evasion", re: /(tax evasion|evasion)/i },
      { tag: "prosociality", re: /(prosocial|cooperat|donor)/i },
    ];

    // ---------------------------
    // State
    // ---------------------------
    let ALL = [];
    let state = {
      type: "all",         // all | peer-reviewed | preprint
      q: "",
      year: null,          // number or null
      topic: null,         // string or null
      pdfOnly: false,
      sort: "newest",
    };

    // ---------------------------
    // Helpers
    // ---------------------------
    const $ = (sel) => document.querySelector(sel);
    const esc = (s) => (s || "").replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));

    function normSpace(s){ return (s || "").replace(/\s+/g," ").trim(); }

    function extractYear(text){
      const m = (text || "").match(/\b(19|20)\d{2}\b/);
      return m ? Number(m[0]) : null;
    }

    function extractDOIFromUrl(url){
      if(!url) return null;
      // common DOI patterns inside URLs
      const m = url.match(/10\.\d{4,9}\/[-._;()\/:A-Z0-9]+/i);
      return m ? m[0] : null;
    }

    function topicTagsFor(pub){
      const tags = [];
      for(const rule of TOPIC_RULES){
        if(rule.re.test(pub.title)) tags.push(rule.tag);
      }
      return tags.length ? tags : ["other"];
    }

    function looksPreprint(venueLine){
      const t = (venueLine || "").toLowerCase();
      return t.includes("ssrn") || t.includes("working paper") || t.includes("preprint") || t.includes("osf");
    }

    function labelType(t){
      return t === "preprint" ? "Pre-print" : "Peer-reviewed";
    }

    function stableIdFromTitle(title){
      return (title || "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g,"-")
        .replace(/^-+|-+$/g,"")
        .slice(0, 80) || ("pub-" + Math.random().toString(16).slice(2));
    }

    function groupByYear(pubs){
      const map = new Map();
      for(const p of pubs){
        const y = p.year || 0;
        if(!map.has(y)) map.set(y, []);
        map.get(y).push(p);
      }
      const years = Array.from(map.keys()).sort((a,b) => b - a);
      return years.map(y => ({year:y, pubs: map.get(y)}));
    }

    function setActive(el, on){
      if(on) el.classList.add("active");
      else el.classList.remove("active");
    }

    function toast(msg){
      // lightweight, no dependency
      const t = document.createElement("div");
      t.textContent = msg;
      t.style.position="fixed";
      t.style.left="50%";
      t.style.bottom="18px";
      t.style.transform="translateX(-50%)";
      t.style.padding="10px 12px";
      t.style.border="1px solid rgba(231,238,252,.22)";
      t.style.borderRadius="12px";
      t.style.background="rgba(15,26,47,.96)";
      t.style.color="var(--text)";
      t.style.fontWeight="700";
      t.style.fontSize="13px";
      t.style.boxShadow="0 10px 25px rgba(0,0,0,.35)";
      t.style.zIndex="9999";
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity="0"; t.style.transition="opacity .2s"; }, 1800);
      setTimeout(()=>{ t.remove(); }, 2100);
    }

    async function copyText(s){
      try{
        await navigator.clipboard.writeText(s);
        toast("Copied.");
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = s;
        ta.style.position="fixed";
        ta.style.left="-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("Copied.");
      }
    }

    function buildBibtexFromCrossref(item, fallbackKey){
      const t = item?.title?.[0] || item?.title || fallbackKey || "untitled";
      const authors = (item?.author || []).map(a => {
        const last = a.family || "";
        const first = a.given || "";
        return (last && first) ? `${last}, ${first}` : (last || first || "");
      }).filter(Boolean).join(" and ");

      const year = item?.issued?.["date-parts"]?.[0]?.[0] || item?.published?.["date-parts"]?.[0]?.[0] || "";
      const container = (item?.["container-title"]?.[0] || item?.["container-title"] || "").toString();
      const volume = item?.volume || "";
      const issue = item?.issue || "";
      const page = item?.page || "";
      const doi = item?.DOI || "";
      const url = item?.URL || "";

      const keyBase = (authors.split(" and ")[0] || "dimant").split(",")[0].replace(/\s+/g,"");
      const key = `${keyBase}${year || ""}`.replace(/[^A-Za-z0-9]/g,"") || (fallbackKey || "dimant");

      const lines = [];
      lines.push(`@article{${key},`);
      lines.push(`  title = {${t}},`);
      if(authors) lines.push(`  author = {${authors}},`);
      if(container) lines.push(`  journal = {${container}},`);
      if(year) lines.push(`  year = {${year}},`);
      if(volume) lines.push(`  volume = {${volume}},`);
      if(issue) lines.push(`  number = {${issue}},`);
      if(page) lines.push(`  pages = {${page}},`);
      if(doi) lines.push(`  doi = {${doi}},`);
      if(url) lines.push(`  url = {${url}},`);
      lines.push(`}`);
      return lines.join("\n");
    }

    async function copyBibtex(pub){
      // Prefer DOI from a known journal URL if present.
      const doi = pub.doi || extractDOIFromUrl(pub.links?.paper) || extractDOIFromUrl(pub.links?.journal) || null;

      try{
        if(doi){
          const r = await fetch(`https://api.crossref.org/works/${encodeURIComponent(doi)}`);
          if(!r.ok) throw new Error("crossref lookup failed");
          const j = await r.json();
          const bib = buildBibtexFromCrossref(j?.message, stableIdFromTitle(pub.title));
          await copyText(bib);
          return;
        }

        // fallback: bibliographic search by title
        const q = encodeURIComponent(pub.title);
        const r = await fetch(`https://api.crossref.org/works?query.bibliographic=${q}&rows=1`);
        if(!r.ok) throw new Error("crossref search failed");
        const j = await r.json();
        const item = j?.message?.items?.[0];
        if(!item) throw new Error("no match");
        const bib = buildBibtexFromCrossref(item, stableIdFromTitle(pub.title));
        await copyText(bib);
      }catch(e){
        toast("Could not fetch BibTeX automatically.");
      }
    }

    function scholarSearchUrl(title){
      return `https://scholar.google.com/scholar?q=${encodeURIComponent(title)}`;
    }

    // ---------------------------
    // Legacy page parsing
    // ---------------------------
    function parseLegacyResearch(html){
      const doc = new DOMParser().parseFromString(html, "text/html");
      const root = doc.querySelector("main") || doc.body;

      // Heuristic: publications appear as repeating blocks with a title line and nearby action links.
      // We collect candidate containers that contain a 'Link to Paper' anchor.
      const anchors = Array.from(root.querySelectorAll("a")).filter(a => a.textContent && a.href);
      const paperLinks = anchors.filter(a => /Link to Paper/i.test(a.textContent));

      // Expand each 'Link to Paper' anchor to a container.
      const containers = [];
      for(const a of paperLinks){
        const c = a.closest("div, section, article") || a.parentElement;
        if(c) containers.push(c);
      }

      // De-duplicate containers by reference.
      const uniq = [];
      const seen = new Set();
      for(const c of containers){
        if(seen.has(c)) continue;
        seen.add(c);
        uniq.push(c);
      }

      const pubs = [];
      for(const c of uniq){
        const text = normSpace(c.textContent);

        // title: first reasonably long line, excluding link labels
        const lines = c.textContent.split("\n").map(s => normSpace(s)).filter(Boolean);
        const drop = new Set(["Link to Paper","Ungated Version","AI Podcast Interview","BibTeX Citation","Open-access search","Copy citation","Find on Scholar","Open PDF","Paper","Link to WP","Norm -Drawing Task"]);
        const title = lines.find(s =>
          s.length > 8 &&
          !drop.has(s) &&
          !/^(research|peer-reviewed|work in progress|results|sort|jump to)/i.test(s)
        ) || "Untitled";

        // venue line often contains "with ..." and a journal name
        const venueLine = lines.find(s => /^with\s/i.test(s)) || "";

        const year = extractYear(venueLine) || extractYear(text);
        const type = looksPreprint(venueLine) ? "preprint" : "peer-reviewed";

        const linkMap = {};
        const localAnchors = Array.from(c.querySelectorAll("a")).filter(a => a.textContent && a.href);
        for(const a of localAnchors){
          const label = normSpace(a.textContent);
          if(/Link to Paper/i.test(label)) linkMap.paper = a.href;
          else if(/Ungated Version/i.test(label)) linkMap.pdf = a.href;
          else if(/AI Podcast Interview/i.test(label)) linkMap.podcast = a.href;
          else if(/Link to WP/i.test(label)) linkMap.wp = a.href;
          else if(/Norm\s*-Drawing Task/i.test(label)) linkMap.wp = a.href;
        }

        pubs.push({
          id: stableIdFromTitle(title),
          title,
          venueLine,
          year,
          type,
          topics: topicTagsFor({title}),
          links: linkMap,
          doi: extractDOIFromUrl(linkMap.paper || "")
        });
      }

      // Some publications may not include a Link to Paper but do include "Link to WP" (work in progress).
      // Add those containers too.
      const wpLinks = anchors.filter(a => /Link to WP|Norm\s*-Drawing Task/i.test(a.textContent));
      for(const a of wpLinks){
        const c = a.closest("div, section, article") || a.parentElement;
        if(!c || seen.has(c)) continue;
        seen.add(c);
        const lines = c.textContent.split("\n").map(s => normSpace(s)).filter(Boolean);
        const title = lines.find(s => s.length > 8 && !/^(Link to WP|Norm\s*-Drawing Task)$/i.test(s)) || "Untitled";
        const venueLine = lines.find(s => /^with\s/i.test(s)) || "Working paper";
        const year = extractYear(venueLine) || extractYear(c.textContent);
        const linkMap = {};
        const localAnchors = Array.from(c.querySelectorAll("a")).filter(a => a.textContent && a.href);
        for(const la of localAnchors){
          const label = normSpace(la.textContent);
          if(/Link to WP|Norm\s*-Drawing Task/i.test(label)) linkMap.wp = la.href;
          else if(/Ungated Version/i.test(label)) linkMap.pdf = la.href;
        }
        pubs.push({
          id: stableIdFromTitle(title),
          title,
          venueLine,
          year,
          type:"preprint",
          topics: topicTagsFor({title}),
          links: linkMap,
          doi: null
        });
      }

      // de-dup by title
      const out = [];
      const titleSet = new Set();
      for(const p of pubs){
        const k = p.title.toLowerCase();
        if(titleSet.has(k)) continue;
        titleSet.add(k);
        out.push(p);
      }
      return out;
    }

    async function loadPubs(){
      const note = $("#sourceNote");
      try{
        const r = await fetch(LEGACY_RESEARCH_URL, { mode: "cors" });
        if(!r.ok) throw new Error("legacy fetch failed");
        const html = await r.text();
        const pubs = parseLegacyResearch(html);
        if(!pubs.length) throw new Error("no publications parsed");
        note.innerHTML = "Loaded publications from the legacy research page.";
        return pubs;
      }catch(e){
        note.innerHTML = "Could not load the legacy research page directly (likely blocked by the browser). Using embedded legacy view for complete links.";
        $("#legacyFallback").style.display = "block";
        return [];
      }
    }

    // ---------------------------
    // Rendering
    // ---------------------------
    function applyFilters(){
      const q = state.q.toLowerCase();
      let pubs = ALL.slice();

      if(state.type !== "all"){
        pubs = pubs.filter(p => p.type === state.type);
      }
      if(state.year){
        pubs = pubs.filter(p => (p.year || null) === state.year);
      }
      if(state.topic){
        pubs = pubs.filter(p => (p.topics || []).includes(state.topic));
      }
      if(state.pdfOnly){
        pubs = pubs.filter(p => !!(p.links?.pdf));
      }
      if(q){
        pubs = pubs.filter(p => {
          const hay = (p.title + " " + (p.venueLine || "")).toLowerCase();
          return hay.includes(q);
        });
      }

      // sort
      if(state.sort === "newest"){
        pubs.sort((a,b) => (b.year || 0) - (a.year || 0) || a.title.localeCompare(b.title));
      }else if(state.sort === "oldest"){
        pubs.sort((a,b) => (a.year || 0) - (b.year || 0) || a.title.localeCompare(b.title));
      }else{
        pubs.sort((a,b) => a.title.localeCompare(b.title));
      }

      return pubs;
    }

    function renderChips(){
      const yearsEl = $("#years");
      const topicsEl = $("#topics");
      yearsEl.innerHTML = "";
      topicsEl.innerHTML = "";

      const base = (state.type === "all") ? ALL : ALL.filter(p => p.type === state.type);

      // years
      const yearCounts = new Map();
      for(const p of base){
        const y = p.year || null;
        if(!y) continue;
        yearCounts.set(y, (yearCounts.get(y) || 0) + 1);
      }
      const years = Array.from(yearCounts.keys()).sort((a,b) => b - a);
      for(const y of years){
        const el = document.createElement("div");
        el.className = "chip" + ((state.year === y) ? " active" : "");
        el.textContent = `${y} ${yearCounts.get(y)}`;
        el.onclick = () => { state.year = (state.year === y) ? null : y; render(); };
        yearsEl.appendChild(el);
      }

      // topics
      const topicCounts = new Map();
      for(const p of base){
        for(const t of (p.topics || [])){
          topicCounts.set(t, (topicCounts.get(t) || 0) + 1);
        }
      }
      const topics = Array.from(topicCounts.entries())
        .sort((a,b) => b[1] - a[1] || a[0].localeCompare(b[0]))
        .slice(0, 18);

      for(const [t,count] of topics){
        const el = document.createElement("div");
        el.className = "chip" + ((state.topic === t) ? " active" : "");
        el.textContent = `${t} ${count}`;
        el.onclick = () => { state.topic = (state.topic === t) ? null : t; render(); };
        topicsEl.appendChild(el);
      }
    }

    function renderJump(yearGroups){
      const sel = $("#jump");
      const years = yearGroups.map(g => g.year).filter(y => y);
      sel.innerHTML = `<option value="">--</option>` + years.map(y => `<option value="${y}">${y}</option>`).join("");
      sel.onchange = () => {
        const y = Number(sel.value);
        if(!y) return;
        const el = document.getElementById(`year-${y}`);
        if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
      };
    }

    function pubActions(pub){
      const a = [];
      const links = pub.links || {};
      // Always show a journal action: open direct paper link if present, else open scholar search.
      const journalHref = links.paper || scholarSearchUrl(pub.title);

      a.push(`<a href="${esc(journalHref)}" target="_blank" rel="noopener">Journal site</a>`);
      if(links.pdf) a.push(`<a href="${esc(links.pdf)}" target="_blank" rel="noopener">PDF (Drive)</a>`);
      else a.push(`<a href="${esc(scholarSearchUrl(pub.title))}" target="_blank" rel="noopener" title="No PDF link found on the legacy page">Scholar search</a>`);
      if(links.podcast) a.push(`<a href="${esc(links.podcast)}" target="_blank" rel="noopener">AI podcast</a>`);
      if(links.wp) a.push(`<a href="${esc(links.wp)}" target="_blank" rel="noopener">Working paper</a>`);
      a.push(`<button type="button" data-bib="${esc(pub.id)}">Copy BibTeX</button>`);
      return a.join("");
    }

    function renderResults(pubs){
      const results = $("#results");
      const count = $("#count");
      count.textContent = `${pubs.length} result${pubs.length === 1 ? "" : "s"}`;

      if(!pubs.length){
        results.innerHTML = `<div class="notice">No matches. Try clearing a filter or changing the search term.</div>`;
        return;
      }

      const grouped = groupByYear(pubs);
      renderJump(grouped);

      let html = "";
      for(const g of grouped){
        const y = g.year || 0;
        html += `<div class="year-group" id="year-${y}">`;
        html += `<div class="year-label"><h3>${y ? y : "Unknown year"}</h3><a class="backlink" href="#research">Back to filters</a></div>`;
        for(const p of g.pubs){
          const yearBadge = p.year ? `<span class="badge year">${p.year}</span>` : "";
          const typeBadge = `<span class="badge type">${labelType(p.type)}</span>`;
          const topicBadges = (p.topics || []).slice(0,2).map(t => `<span class="badge">${esc(t)}</span>`).join("");

          html += `
            <div class="pub">
              <div>
                <h4 class="pub-title">${esc(p.title)}</h4>
                <div class="pub-badges">
                  ${yearBadge}
                  ${typeBadge}
                  ${topicBadges}
                </div>
                <div class="pub-meta">${esc(p.venueLine || "")}</div>
                <div class="pub-actions">${pubActions(p)}</div>
              </div>
            </div>
          `;
        }
        html += `</div>`;
      }

      results.innerHTML = html;

      // wire BibTeX buttons
      results.querySelectorAll("button[data-bib]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-bib");
          const pub = ALL.find(p => p.id === id);
          if(pub) copyBibtex(pub);
        });
      });
    }

    function render(){
      renderChips();
      const pubs = applyFilters();
      renderResults(pubs);
    }

    function wireUI(){
      // tabs
      document.querySelectorAll(".tab").forEach(t => {
        t.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
          t.classList.add("active");
          state.type = t.dataset.type;
          state.year = null;
          state.topic = null;
          render();
        });
        t.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            t.click();
          }
        });
      });

      // search
      $("#q").addEventListener("input", (e) => { state.q = e.target.value; render(); });

      // pdf only
      $("#pdfOnly").addEventListener("change", (e) => { state.pdfOnly = e.target.checked; render(); });

      // sort
      $("#sort").addEventListener("change", (e) => { state.sort = e.target.value; render(); });

      // smooth scrolling for hash nav
      window.addEventListener("hashchange", () => {
        const id = location.hash?.slice(1);
        if(!id) return;
        const el = document.getElementById(id);
        if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
      });
    }

    // ---------------------------
    // Init
    // ---------------------------
    (async function init(){
      $("#year").textContent = new Date().getFullYear();

      wireUI();

      ALL = await loadPubs();
      // If parsing failed, keep UI alive but show the embedded legacy page.
      if(!ALL.length){
        $("#count").textContent = "Legacy view";
        $("#results").innerHTML = "";
        return;
      }

      render();
    })();
  </script>
</body>
</html>
